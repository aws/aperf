name: Release

on:
  release:
    types: [published]

permissions:
  id-token: write
  contents: read
  actions: read

jobs:
  linux_build:
    name: Build Linux binaries
    uses: ./.github/workflows/ci.yml
  cross_platform_build:
    name: Build cross-platform binaries
    uses: ./.github/workflows/cross-platform-ci.yml
  release:
    name: Create and upload release artifacts
    runs-on:
      - ubuntu-24.04
    permissions:
      contents: write
    needs:
      - linux_build
      - cross_platform_build
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@eb238b55efaa70779f274895e782ed17c84f2895 # v2.6.1
        with:
          egress-policy: audit

      # Download and unpack all release artifacts
      - name: Download built binaries
        uses: actions/download-artifact@v4

      # Create release tarballs
      - name: Create x86_64 artifacts
        run: |
          name=aperf-${{ github.ref_name }}-x86_64
          mkdir "$name"
          tar -zxvf x86_64-release-artifacts/artifacts.tar.gz -C "$name"
          tar -zcvf "$name".tar.gz "$name"
      - name: Create aarch64 artifacts
        run: |
          name=aperf-${{ github.ref_name }}-aarch64
          mkdir "$name"
          tar -zxvf aarch64-release-artifacts/artifacts.tar.gz -C "$name"
          tar -zcvf "$name".tar.gz "$name"
      - name: Create MacOS artifacts
        run: |
          name=aperf-${{ github.ref_name }}-macos
          tar -zcvf "$name".tar.gz -C macos-release-artifacts aperf
      - name: Create Windows artifacts
        run: |
          name=aperf-${{ github.ref_name }}-windows
          tar -zcvf "$name".tar.gz -C windows-release-artifacts aperf.exe

      # Attach them to the release
      - name: Upload x86_64 artifacts
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./aperf-${{ github.ref_name }}-x86_64.tar.gz
          tag: ${{ github.ref }}
          asset_name: aperf-${{ github.ref_name }}-x86_64.tar.gz
      - name: Upload aarch64 artifacts
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./aperf-${{ github.ref_name }}-aarch64.tar.gz
          tag: ${{ github.ref }}
          asset_name: aperf-${{ github.ref_name }}-aarch64.tar.gz
      - name: Upload MacOS artifacts
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./aperf-${{ github.ref_name }}-macos.tar.gz
          tag: ${{ github.ref }}
          asset_name: aperf-${{ github.ref_name }}-macos.tar.gz
      - name: Upload Windows artifacts
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./aperf-${{ github.ref_name }}-windows.tar.gz
          tag: ${{ github.ref }}
          asset_name: aperf-${{ github.ref_name }}-windows.tar.gz

  ecr-publish:
    name: Build image and publish to ECR
    needs: release
    uses: ./.github/workflows/ecr-publish.yml
    with:
      aperf_version: ${{ github.ref_name }}
    secrets:
      ecr_registry_alias: ${{ secrets.ECR_REGISTRY_ALIAS }}
      ecr_publish_role_arn: ${{ secrets.ECR_PUBLISH_ROLE_ARN }}

  notify:
    name: Send release notifications
    runs-on:
      - ubuntu-24.04
    needs: ecr-publish
    steps:
      - name: Notify Slack Webhook
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RELEASE_URL: ${{ github.event.release.html_url }}
          VERSION: ${{ github.ref_name }}
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          set -e

          # Validate webhook URL exists
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "Error: SLACK_WEBHOOK_URL secret is not set"
            exit 1
          fi

          # Build JSON payload using environment variables
          payload=$(jq -n \
            --arg release_url "$RELEASE_URL" \
            --arg version "$VERSION" \
            --arg body "$RELEASE_BODY" \
            '{
              release_url: $release_url,
              version: $version,
              body: $body
            }')

          # Send notification with error handling
          http_code=$(curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            --data "$payload" \
            --silent \
            --output /tmp/slack_response.txt \
            --write-out "%{http_code}")

          # Check response code
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "Slack notification sent successfully (HTTP $http_code)"
          else
            echo "Slack notification failed with HTTP $http_code"
            echo "Response:"
            cat /tmp/slack_response.txt
            exit 1
          fi
