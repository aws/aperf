#!/bin/sh
set -e

if [ "$1" = "configure" ]; then
    # Install shell completions
    /usr/bin/aperf setup-shell-completions --shell bash --install 2>/dev/null || true
    /usr/bin/aperf setup-shell-completions --shell zsh --install 2>/dev/null || true

    echo ""
    echo "------------------------------------------------------------------------------"
    echo "APerf installed successfully!"
    echo "------------------------------------------------------------------------------"

    perf_event_paranoid=$(cat /proc/sys/kernel/perf_event_paranoid 2>/dev/null || echo "2")

    if [ "$perf_event_paranoid" != "-1" ]; then
        echo ""
        echo "For non-root users to collect PMU metrics, set kernel.perf_event_paranoid to -1 (current value: $perf_event_paranoid) by running:"
        echo "  sudo sysctl -w kernel.perf_event_paranoid=-1"
    fi

    kptr_restrict=$(cat /proc/sys/kernel/kptr_restrict 2>/dev/null || echo "1")

    if [ "$kptr_restrict" != "0" ]; then
        echo ""
        echo "For non-root users to view kernel memory address in perf profile (--profile), set kernel.kptr_restrict to 0 (current value: $kptr_restrict) by running:"
        echo "  sudo sysctl -w kernel.kptr_restrict=0"
    fi

    missing_deps=""
    command -v perf >/dev/null 2>&1 || missing_deps="${missing_deps}\n  - perf (for --profile option)"
    command -v asprof >/dev/null 2>&1 || missing_deps="${missing_deps}\n  - async-profiler (for --profile-java option)"
    command -v jps >/dev/null 2>&1 || missing_deps="${missing_deps}\n  - JDK with jps command (for --profile-java option)"

    if [ -n "$missing_deps" ]; then
        echo ""
        echo "Optional dependencies not found:$missing_deps"
    fi

    echo ""
    echo "Quick start:"
    echo "  aperf record -r my_run -i 1 -p 60"
    echo "  aperf report -r my_run -n my_report"
    echo ""
    echo "Documentation: https://github.com/aws/aperf"
    echo "------------------------------------------------------------------------------"
    echo ""
fi

#DEBHELPER#
